# NeÃ³ptica Intranet â€” Backend API

---

## ğŸŸ¢ **ActualizaciÃ³n de Progreso y Estado Fase 1** (29/05/2025)

### Avances Realizados
- **MÃ³dulos CRUD completos** para Productos, Colores, Marcas, Sucursales, Usuarios e Inventario, con endpoints REST y validaciÃ³n robusta.
- **GestiÃ³n de Inventario**: CRUD completo implementado, incluyendo movimientos de stock, validaciones, transacciones atÃ³micas y registro histÃ³rico para auditorÃ­a.
- **Adjuntos de Inventario**: API para subir, listar, descargar y eliminar archivos adjuntos de inventario implementada y testeada. ResoluciÃ³n de problemas de middleware de autenticaciÃ³n y validaciÃ³n.
- **AutenticaciÃ³n**: Login JWT y OAuth (Google, Facebook, Instagram) funcionando, recuperaciÃ³n de contraseÃ±a implementada y validada.
- **AuditorÃ­a**: Sistema de auditorÃ­a completo, registra todas las operaciones CRUD relevantes y errores para todos los mÃ³dulos, incluyendo inventario.
- **Roles y permisos**: Middleware de roles y JWT para proteger rutas segÃºn permisos.
- **Testing**: 238 tests automÃ¡ticos (Jest) cubriendo autenticaciÃ³n, usuarios, roles, productos, sucursales, colores, marcas, inventario y adjuntos. Todos los tests pasan y la salida estÃ¡ limpia de logs innecesarios.
- **DocumentaciÃ³n**: Swagger/OpenAPI documentando todos los endpoints principales.
- **Seed y migraciones**: Scripts de seed y migraciones Prisma funcionando correctamente.

### Pendientes para Finalizar Fase 1
- [ ] **Modelos y endpoints de Stock y Pedido**: Faltan implementar modelos y endpoints bÃ¡sicos para stock y pedidos (ver checklist en README).
- [ ] **GestiÃ³n de clientes**: La gestiÃ³n de clientes se realiza mediante el modelo `usuario` (no existe modelo cliente independiente). AsegÃºrate de que los endpoints y roles permitan registrar y distinguir usuarios de tipo cliente.
- [ ] **Diagrama de base de datos actualizado**: Agregar/exportar el diagrama ERD actualizado.
- [ ] **Ejemplos de uso en Postman**: Exportar y documentar colecciones de pruebas para facilitar QA/UAT.
- [ ] **Variables de entorno de producciÃ³n**: Revisar y definir .env para despliegue (seguridad, emails, OAuth, etc).
- [ ] **Logs de errores para producciÃ³n**: Configurar logging robusto para errores crÃ­ticos y advertencias.
- [ ] **(Opcional) DockerizaciÃ³n y CI/CD**: Mejorar despliegue y portabilidad.

### Recomendaciones
- Priorizar la implementaciÃ³n de los modelos y endpoints faltantes (Stock y Pedido) para cumplir el alcance de la Fase 1.
- Verificar que la gestiÃ³n de clientes estÃ© correctamente soportada a travÃ©s del modelo `usuario` y sus endpoints.
- Actualizar el diagrama de base de datos tras cada cambio relevante.
- Documentar ejemplos de uso API en Postman para facilitar pruebas y onboarding.
- Revisar checklist de Fase 1 al final del README para verificar el avance.

---


## MÃ³dulos recientes: Color, Marca y Sucursal

Se han agregado los mÃ³dulos **Color**, **Marca** y **Sucursal** al backend para una gestiÃ³n mÃ¡s granular de productos Ã³pticos y puntos de venta:
- **Color**: Permite registrar, listar y administrar los colores disponibles para productos (lentes, armazones, etc.).
- **Marca**: Permite registrar, listar y administrar las marcas comerciales de productos.
- **Sucursal**: Permite registrar, listar y administrar las sucursales o puntos de venta de la empresa.

Todos estos mÃ³dulos siguen la arquitectura, validaciÃ³n, seguridad y convenciones del proyecto (Express + Prisma + JWT + roles). Sus endpoints son RESTful y estÃ¡n alineados a la convenciÃ³n `{ ok, data, error }`.

**Endpoints disponibles:**
- `/api/colores`: CRUD de colores
- `/api/marcas`: CRUD de marcas
- `/api/sucursales`: CRUD de sucursales

## RecuperaciÃ³n de ContraseÃ±a Implementada

Se ha implementado un flujo completo y seguro de recuperaciÃ³n de contraseÃ±a que sigue las mejores prÃ¡cticas de seguridad:

### CaracterÃ­sticas de la recuperaciÃ³n de contraseÃ±a:

1. **Solicitud de recuperaciÃ³n segura:**
   - Endpoint `/api/auth/forgot-password` para solicitar el restablecimiento
   - GeneraciÃ³n de tokens seguros con crypto
   - Tokens encriptados con bcrypt antes de almacenarse
   - Tokens con expiraciÃ³n de 24 horas
   - IntegraciÃ³n con sistema de correo electrÃ³nico

2. **Restablecimiento seguro:**
   - Endpoint `/api/auth/reset-password` para restablecer la contraseÃ±a
   - ValidaciÃ³n de token, email y fuerza de la nueva contraseÃ±a
   - InvalidaciÃ³n automÃ¡tica de tokens despuÃ©s de su uso
   - ValidaciÃ³n de contraseÃ±as seguras (mayÃºsculas, minÃºsculas, nÃºmeros)

3. **ProtecciÃ³n contra ataques:**
   - Ocultamiento de la existencia de emails en la base de datos
   - Respuesta genÃ©rica para solicitudes de emails vÃ¡lidos e invÃ¡lidos
   - AuditorÃ­a detallada de todas las solicitudes y resultados
   - Control de campos temporales (creado_por, modificado_por)

4. **AuditorÃ­a completa:**
   - Registro de cada intento de recuperaciÃ³n
   - Registro de restablecimientos exitosos y fallidos
   - Trazabilidad del proceso completo

## Sistema de AuditorÃ­a Implementado

Se ha implementado un sistema completo de auditorÃ­a para todos los mÃ³dulos CRUD (marcas, colores y sucursales) que registra cada acciÃ³n en la tabla `log_auditoria`, garantizando la trazabilidad y seguridad de todas las operaciones:

### CaracterÃ­sticas del sistema de auditorÃ­a:

1. **Registro detallado de cada operaciÃ³n:**
   - Usuario que realizÃ³ la acciÃ³n
   - Tipo de acciÃ³n (crear, listar, obtener, actualizar, eliminar)
   - DescripciÃ³n detallada de la acciÃ³n
   - IP desde donde se realizÃ³
   - Entidad afectada y su ID
   - MÃ³dulo al que pertenece

2. **Campos de control temporal:**
   - `creado_por` y `creado_en` al crear registros
   - `modificado_por` y `modificado_en` al actualizar registros
   - `anulado_por` y `anulado_en` al realizar soft delete

3. **Registro de operaciones fallidas:**
   - Cada intento fallido tambiÃ©n se registra
   - Se captura el tipo de error para facilitar soluciÃ³n de problemas

4. **Seguridad integral:**
   - No se permite eliminar registros de auditorÃ­a bajo ningÃºn concepto
   - Garantiza completa trazabilidad de todas las operaciones

### Endpoints de AuditorÃ­a (Nuevos)

Se ha implementado un nuevo controlador y rutas especÃ­ficas para la consulta y filtrado de los registros de auditorÃ­a:

- **GET** `/api/auditoria` â€” Lista todos los registros de auditorÃ­a con paginaciÃ³n y filtros (solo admin)
- **GET** `/api/auditoria/:id` â€” Obtiene un registro de auditorÃ­a por su ID (solo admin)
- **GET** `/api/auditoria/modulo/:modulo` â€” Filtra registros de auditorÃ­a por mÃ³dulo (solo admin)
- **GET** `/api/auditoria/usuario/:id` â€” Filtra registros de auditorÃ­a por usuario (solo admin)

Estos endpoints permiten una completa trazabilidad de todas las operaciones realizadas en el sistema, con capacidades avanzadas de filtrado por mÃ³dulo, usuario, acciÃ³n, rango de fechas y mÃ¡s.

## Repositorio oficial del backend de la plataforma NeÃ³ptica Intranet.
Desarrollado en Node.js + Express + TypeScript + Prisma ORM + PostgreSQL, seguro y escalable, con autenticaciÃ³n JWT y arquitectura modular.

## Tabla de contenidos
- [CaracterÃ­sticas](#caracterÃ­sticas)
- [Requisitos](#requisitos)
- [InstalaciÃ³n y puesta en marcha](#instalaciÃ³n-y-puesta-en-marcha)
- [Scripts principales](#scripts-principales)
- [Estructura de carpetas](#estructura-de-carpetas)
- [Variables de entorno](#variables-de-entorno)
- [Seed de base de datos](#seed-de-base-de-datos)
- [Convenciones de respuesta API](#convenciones-de-respuesta-api)
- [GuÃ­a para implementaciÃ³n de CRUD](#guÃ­a-para-implementaciÃ³n-de-crud)
- [ConfiguraciÃ³n de autenticaciÃ³n](#configuraciÃ³n-de-autenticaciÃ³n)
- [Testing y buenas prÃ¡cticas](#testing-y-buenas-prÃ¡cticas)
- [Endpoints principales](#endpoints-principales)
- [DocumentaciÃ³n Swagger](#documentaciÃ³n-swagger)
- [Checklist de Fase 1](#checklist-de-fase-1)
- [MÃ³dulos recientes: Color y Marca](#modulos-recientes-color-y-marca)
- [Contribuciones y flujo de trabajo](#contribuciones-y-flujo-de-trabajo)
- [Licencia](#licencia)

## CaracterÃ­sticas
- MÃ³dulos recientes: **Color**, **Marca** y **Sucursal** agregados al esquema y planificaciÃ³n (ver secciÃ³n dedicada).
- Sistema completo de **AuditorÃ­a** para todas las operaciones CRUD
- TypeScript y tipado estricto
- Express modular, imports absolutos (@/)
- Prisma ORM con PostgreSQL
- AutenticaciÃ³n JWT
- Sistema de roles
- Helpers estÃ¡ndar para responses y errores
- Semillas (seed) iniciales de usuarios y roles
- Testing y build para producciÃ³n
- FÃ¡cil integraciÃ³n con frontend (RESTful)

## Requisitos
- Node.js v18+
- npm v9+
- PostgreSQL 13+
- [Opcional] Docker para entorno controlado


## Estructura de carpetas
```plaintext
backend/
  â”œâ”€â”€ src/
  â”‚   â”œâ”€â”€ controllers/
  â”‚   â”‚   â”œâ”€â”€ productoController.ts
  â”‚   â”‚   â”œâ”€â”€ colorController.ts        # MÃ³dulo implementado
  â”‚   â”‚   â”œâ”€â”€ marcaController.ts        # MÃ³dulo implementado
  â”‚   â”‚   â”œâ”€â”€ sucursalController.ts     # MÃ³dulo implementado
  â”‚   â”‚   â””â”€â”€ auditoriaController.ts    # MÃ³dulo implementado
  â”‚   â”œâ”€â”€ routes/
  â”‚   â”‚   â”œâ”€â”€ producto.ts
  â”‚   â”‚   â”œâ”€â”€ color.ts                  # MÃ³dulo implementado
  â”‚   â”‚   â”œâ”€â”€ marca.ts                  # MÃ³dulo implementado
  â”‚   â”‚   â”œâ”€â”€ sucursales.ts             # MÃ³dulo implementado
  â”‚   â”‚   â””â”€â”€ auditoria.ts              # MÃ³dulo implementado
  â”‚   â””â”€â”€ ...
â”œâ”€â”€ .env                  # Variables de entorno
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ jest.config.js        # ConfiguraciÃ³n de tests
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ tsconfig.json         # ConfiguraciÃ³n TS
â”œâ”€â”€ tsconfig.test.json    # ConfiguraciÃ³n TS para tests
â”œâ”€â”€ coverage/             # Reportes de cobertura
â”œâ”€â”€ node_modules/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma     # Esquema de base de datos
â”‚   â”œâ”€â”€ seed.ts           # Script de datos iniciales
â”‚   â””â”€â”€ migrations/       # Migraciones Prisma
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.ts            # ConfiguraciÃ³n principal Express
â”‚   â”œâ”€â”€ index.ts          # Entry point
â”‚   â”œâ”€â”€ controllers/      # LÃ³gica de negocio (usuarioController.ts, etc.)
â”‚   â”œâ”€â”€ middlewares/      # Middlewares personalizados
â”‚   â”œâ”€â”€ prisma/           # Cliente Prisma
â”‚   â”œâ”€â”€ routes/           # DefiniciÃ³n de rutas (API)
â”‚   â””â”€â”€ utils/            # Utilidades y helpers
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ usuarios.test.ts  # Test avanzado de usuarios y edge cases
```

## Variables de entorno
Ejemplo mÃ­nimo (`.env`):
```ini
DATABASE_URL=postgresql://user:password@localhost:5432/neoptica_db
JWT_SECRET=tu_clave_secreta_segura
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=usuario
SMTP_PASS=clave
```
- Ajusta las variables segÃºn tu entorno local o de producciÃ³n.
- **Nunca subas tus credenciales reales al repositorio.**

## Seed de base de datos
- El script de seed crea los roles base (admin, optometrista, vendedor), un usuario administrador y asocia roles.
- Ejecuta:
```bash
npx prisma db seed
```
- Verifica que los datos iniciales estÃ©n en la base o usa npx prisma studio para inspeccionar.

## Scripts principales
```json
"scripts": {
  "dev": "nodemon --watch 'src/**/*.ts' --exec ts-node -r tsconfig-paths/register src/index.ts",
  "build": "tsc",
  "start": "node build/index.js"
}
```
- dev: desarrollo con hot reload
- build: compila TypeScript a JavaScript (/build)
- start: ejecuta el servidor en modo producciÃ³n

## Helper global de respuestas
Para garantizar consistencia en las respuestas de la API (tanto en Ã©xito como en error), el backend utiliza un helper global centralizado en src/utils/response.ts.
### Estructura
Para centralizar y garantizar este formato en todo el backend, se utiliza un helper en src/utils/response.ts:
```typescript
// src/utils/response.ts

export interface ApiResponse<T = any> {
  ok: boolean;
  data: T | null;
  error: string | null;
}

export function success<T = any>(data: T): ApiResponse<T> {
  return {
    ok: true,
    data,
    error: null,
  };
}

export function fail(error: string, data: any = null): ApiResponse {
  return {
    ok: false,
    data,
    error,
  };
}
```

## Convenciones de respuesta API
Todas las respuestas siguen este formato uniforme:
```json
{
  "ok": true,          // Indica Ã©xito (true) o error (false)
  "data": { ... },     // Objeto o arreglo con los datos de la respuesta (null si hubo error)
  "error": null        // Mensaje de error en caso de fallo, null si es Ã©xito
}
```

Ejemplo de Ã©xito:
```json
{
  "ok": true,
  "data": {
    "id": "0cd2bebd-d1eb-42b0-b040-b555cd726322",
    "nombre_completo": "Administrador General",
    "email": "admin@neoptica.com"
    // ...otros campos
  },
  "error": null
}
```

Ejemplo de error:
```json
{
  "ok": false,
  "data": null,
  "error": "Usuario no encontrado"
}
```


## Endpoints REST implementados (Fase 1)
- **Auth**
  - POST   `/api/auth/login`           â€” Login, retorna JWT y datos de usuario
  - POST   `/api/auth/google`          â€” Inicia autenticaciÃ³n con Google OAuth
  - GET    `/api/auth/google/callback` â€” Callback para autenticaciÃ³n Google
  - POST   `/api/auth/facebook`        â€” Inicia autenticaciÃ³n con Facebook OAuth
  - GET    `/api/auth/facebook/callback` â€” Callback para autenticaciÃ³n Facebook
  - POST   `/api/auth/instagram`       â€” Inicia autenticaciÃ³n con Instagram OAuth
  - GET    `/api/auth/instagram/callback` â€” Callback para autenticaciÃ³n Instagram

- **Usuarios**
  - GET    `/api/usuarios`             â€” Lista usuarios (admin)
  - POST   `/api/usuarios`             â€” Crea usuario (admin)
  - GET    `/api/usuarios/:id`         â€” Consulta usuario por ID (admin y self)
  - PUT    `/api/usuarios/:id`         â€” Edita usuario (admin y self)
  - DELETE `/api/usuarios/:id`         â€” Desactiva usuario (admin)
  - POST   `/api/usuarios/:id/reset-password` â€” Cambio de contraseÃ±a (admin)
  
- **Roles**
  - GET    `/api/roles`                â€” Lista roles disponibles (solo lectura)

- **Productos**
  - GET    `/api/productos`            â€” Lista productos (paginado y filtrado)
  - POST   `/api/productos`            â€” Crea producto (admin, vendedor, optometrista)
  - GET    `/api/productos/:id`        â€” Consulta producto por ID
  - PUT    `/api/productos/:id`        â€” Edita producto (admin, vendedor, optometrista)
  - DELETE `/api/productos/:id`        â€” Desactiva producto (admin)

- **Colores**
  - GET    `/api/colores`              â€” Lista colores (paginado y filtrado)
  - POST   `/api/colores`              â€” Crea color (admin)
  - GET    `/api/colores/:id`          â€” Consulta color por ID
  - PUT    `/api/colores/:id`          â€” Edita color (admin)

- **AuditorÃ­a**
  - GET    `/api/auditoria`            â€” Lista registros de auditorÃ­a (paginado y filtrado) (admin)
  - GET    `/api/auditoria/:id`        â€” Consulta registro de auditorÃ­a por ID (admin)
  - GET    `/api/auditoria/modulo/:modulo`  â€” Filtra registros por mÃ³dulo (admin)
  - GET    `/api/auditoria/usuario/:id`     â€” Filtra registros por usuario (admin)
  - DELETE `/api/colores/:id`          â€” Desactiva color (soft delete) (admin)

- **Marcas**
  - GET    `/api/marcas`               â€” Lista marcas (paginado y filtrado)
  - POST   `/api/marcas`               â€” Crea marca (admin)
  - GET    `/api/marcas/:id`           â€” Consulta marca por ID
  - PUT    `/api/marcas/:id`           â€” Edita marca (admin)
  - DELETE `/api/marcas/:id`           â€” Desactiva marca (soft delete) (admin)

- **Sucursales**
  - GET    `/api/sucursales`           â€” Lista sucursales (paginado y filtrado)
  - POST   `/api/sucursales`           â€” Crea sucursal (admin)
  - GET    `/api/sucursales/:id`       â€” Consulta sucursal por ID
  - PUT    `/api/sucursales/:id`       â€” Edita sucursal (admin)
  - DELETE `/api/sucursales/:id`       â€” Desactiva sucursal (soft delete) (admin)

- **AuditorÃ­a** (En implementaciÃ³n)
  - GET    `/api/auditoria`            â€” Lista registros de auditorÃ­a (admin)
  - GET    `/api/auditoria/:id`        â€” Consulta registro de auditorÃ­a por ID (admin)
  - GET    `/api/auditoria/modulo/:modulo` â€” Filtra auditorÃ­a por mÃ³dulo (admin)
  - GET    `/api/auditoria/usuario/:id` â€” Filtra auditorÃ­a por usuario (admin)

- **Utilidades**
  - GET    `/api/protegido`            â€” Endpoint protegido de prueba (requiere JWT)
  - GET    `/test-email`               â€” Prueba de envÃ­o de correo
  - GET    `/api/docs`                 â€” DocumentaciÃ³n Swagger/OpenAPI

## Ejemplo de request/response (login)
Request
```json
POST /api/auth/login
Content-Type: application/json

{
  "email": "admin@neoptica.com",
  "password": "Admin1234!"
}
```
Response
```json
{
  "ok": true,
  "data": {
    "token": "<jwt_token>",
    "usuario": {
      "id": "xxx-xxx-xxx",
      "nombre_completo": "Administrador General",
      "email": "admin@neoptica.com",
      "rol": "admin"
    }
  },
  "error": null
}
```
Errores comunes
CÃ³digo  Causa	                    Formato de respuesta
400	    Campos faltantes	        { "ok": false, "data": null, "error": "Email y password son requeridos" }
404	    Usuario no existe	        { "ok": false, "data": null, "error": "Usuario no encontrado" }
401     Password incorrecta/JWT	  { "ok": false, "data": null, "error": "Password incorrecto" }
500	    Error interno	            { "ok": false, "data": null, "error": "Error detallado" }

## Validaciones implementadas (usuarios)

- **Email:** formato vÃ¡lido y Ãºnico (regex)
- **Password:** mÃ­nimo 8 caracteres, al menos una mayÃºscula, una minÃºscula y un nÃºmero
- **TelÃ©fono:** exactamente 10 dÃ­gitos (celular Ecuador)
- **Rol:** Debe existir en la tabla `rol` y ser uno de los definidos (admin, optometrista, vendedor, cliente)
- **No se permite editar contraseÃ±a ni rol desde el endpoint de ediciÃ³n estÃ¡ndar** (sÃ³lo en mÃ³dulo especial admin)

**CÃ³digos de error usados:**
- 400 Bad Request: datos invÃ¡lidos o formato incorrecto
- 409 Conflict: email duplicado
- 403 Forbidden: intento de crear usuario sin rol admin

## Seguridad y Middleware de Roles
El backend implementa control de acceso basado en roles para todos los endpoints protegidos. Usa JWT para autenticaciÃ³n y un middleware dedicado para verificar permisos mÃ­nimos requeridos en cada endpoint.
Ejemplo de uso del middleware en rutas:
```typescript
import { requireRole } from '@/middlewares/roles';

// Solo admins pueden crear usuarios
router.post('/', authenticateJWT, requireRole('admin'), usuarioController.crearUsuario);
```

### Opciones de roles disponibles:
- admin
- optometrista
- vendedor
- cliente

### Recuerda:
- El endpoint de creaciÃ³n de usuario permite especificar el rol.
- El sistema impide modificar el rol y la contraseÃ±a desde el endpoint de ediciÃ³n estÃ¡ndar (solo por mÃ³dulos especiales de administraciÃ³n).


## Pruebas automÃ¡ticas (Jest)
El backend incluye pruebas automÃ¡ticas de integraciÃ³n usando Jest y Supertest.
Las pruebas cubren autenticaciÃ³n, CRUD de usuarios y reglas de negocio bÃ¡sicas, garantizando que todos los endpoints respondan en el formato uniforme **{ ok, data, error }**.
Ejecutar tests:
```bash
npx jest
```
### Recomendaciones:
- Antes de correr los tests, asegÃºrate de tener la base en estado limpio (**npx prisma db seed**).
- Los tests de usuarios limpian la base de datos (excepto el usuario admin) al finalizar.
- Puedes ejecutar en paralelo el backend (**npm run dev**) y los tests.

## DocumentaciÃ³n Swagger/OpenAPI
Toda la API estÃ¡ documentada con Swagger/OpenAPI disponible en:
```bash
GET /api/docs
```
### Incluye:
- Schemas detallados para request/response.
- Ejemplos por cada endpoint.
- DocumentaciÃ³n de errores y validaciones.
- AutenticaciÃ³n JWT Bearer (token) configurable en la UI.

Â¿No ves el botÃ³n "Authorize" o los endpoints protegidos fallan por token?
Verifica que en **src/utils/swagger.ts** estÃ© configurada la seguridad asÃ­:
```typescript
components: {
  securitySchemes: {
    BearerAuth: {
      type: 'http',
      scheme: 'bearer',
      bearerFormat: 'JWT',
    }
  }
},
security: [
  {
    BearerAuth: []
  }
]
```
Y que tus endpoints incluyan **@swagger** con **security: [ { BearerAuth: [] } ]** donde corresponda.

## Validaciones y mensajes de error
Todos los campos sensibles (email, password, telÃ©fono) tienen validaciones estrictas.
- Email: formato vÃ¡lido requerido (valida con regex).
- Password: debe tener al menos 8 caracteres, una mayÃºscula, una minÃºscula y un nÃºmero.
- TelÃ©fono: formato celular ecuatoriano (10 dÃ­gitos).
Errores de validaciÃ³n retornan cÃ³digo 400 y mensaje claro en el campo error del response.

## Ejemplo de tests automÃ¡ticos recomendados
Incluye en tu archivo **tests/usuarios.test.ts** pruebas como:
- No permite crear usuario con email invÃ¡lido
- No permite crear usuario con password dÃ©bil
- No permite crear usuario con nÃºmero celular invÃ¡lido
- No permite editar usuario si no es admin ni self
- El propio usuario puede editar sus datos
- No permite login si usuario estÃ¡ inactivo
### Estrategia de limpieza en tests automÃ¡ticos
Las pruebas automÃ¡ticas limpian la base de datos eliminando todos los usuarios excepto el admin.  
**Importante:** Se eliminan primero las asociaciones `usuario_rol`, luego los usuarios, para evitar errores de integridad referencial.
```typescript
await prisma.usuario_rol.deleteMany({ ... });
await prisma.usuario.deleteMany({ ... });
```
## Advertencia: Los roles del sistema no pueden ser modificados vÃ­a API
### Roles predefinidos y protegidos
En NeÃ³ptica Intranet, los roles de usuario (admin, optometrista, vendedor, cliente) estÃ¡n predefinidos y son parte de la lÃ³gica central del sistema. Por motivos de seguridad y coherencia:
- No existe ningÃºn endpoint para crear, editar ni eliminar roles.
- Ni siquiera los usuarios con rol admin pueden modificar la tabla de roles vÃ­a API.
- Los roles solo pueden ser consultados mediante el endpoint de lectura (GET /api/roles).
- Intentar cualquier otro mÃ©todo (POST, PUT, DELETE) en /api/roles devolverÃ¡ un error 405 (MÃ©todo no permitido).
### Â¿Por quÃ©?
Permitir la manipulaciÃ³n dinÃ¡mica de roles podrÃ­a afectar la integridad, seguridad y lÃ³gica de permisos en toda la plataforma. Los cambios en roles requieren migraciones y validaciones estrictas a nivel de base de datos y cÃ³digo fuente.

## Ejemplo de uso del endpoint seguro de roles
Consulta de roles (solo lectura)
```sql
GET /api/roles
Authorization: Bearer <JWT>
```
Respuesta esperada:
```json
{
  "ok": true,
  "data": [
    { "id": "uuid1", "nombre": "admin", "descripcion": "Administrador global" },
    { "id": "uuid2", "nombre": "optometrista", "descripcion": "Optometrista" },
    { "id": "uuid3", "nombre": "vendedor", "descripcion": "Vendedor de Ã³ptica" },
    { "id": "uuid4", "nombre": "cliente", "descripcion": "Cliente de la Ã³ptica" }
  ],
  "error": null
}
```

## DocumentaciÃ³n Swagger recomendada (Roles)
Agrega esto en tu archivo de rutas o controladores de roles para Swagger (puedes ajustar la sintaxis):
```typescript
/**
 * @swagger
 * tags:
 *   name: Roles
 *   description: GestiÃ³n de roles de usuario (SOLO lectura)
 *
 * /api/roles:
 *   get:
 *     summary: Lista todos los roles predefinidos (solo lectura)
 *     tags: [Roles]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: Lista de roles.
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 ok:
 *                   type: boolean
 *                   example: true
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Rol'
 *                 error:
 *                   type: string
 *                   example: null
 *       401:
 *         $ref: '#/components/responses/Unauthorized'
 *       405:
 *         description: MÃ©todo no permitido para roles.
 */
```
En tus schemas de Swagger:
```yaml
components:
  schemas:
    Rol:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "1c2d3e4f-5a6b-7c8d-9e0f-1a2b3c4d5e6f"
        nombre:
          type: string
          example: "admin"
        descripcion:
          type: string
          example: "Administrador global"
```

## GuÃ­a para implementaciÃ³n de CRUD

Sigue estos lineamientos al crear nuevos endpoints CRUD para asegurar robustez y consistencia:

### 1. Estructura del controlador

Todo controlador debe seguir este patrÃ³n para cada operaciÃ³n CRUD:

```typescript
export const crearEntidad = async (req: Request, res: Response) => {
  try {
    // 1. Extraer y validar datos de entrada
    const { campo1, campo2, ... } = req.body;
    
    // 2. ValidaciÃ³n estricta de tipos y valores
    if (typeof campo1 !== 'string' || campo1.trim().length < 2) {
      return res.status(400).json({ ok: false, data: null, error: 'Mensaje de error claro' });
    }
    
    // 3. OperaciÃ³n de base de datos con Prisma
    const nuevaEntidad = await prisma.entidad.create({
      data: {
        campo1: campo1.trim(),  // Siempre limpia strings
        campo2: campo2 ?? valorDefault,  // Usa valores default seguros
      },
    });
    
    // 4. Respuesta de Ã©xito con formato estÃ¡ndar
    res.status(201).json({ ok: true, data: nuevaEntidad, error: null });
  } catch (error: any) {
    // 5. Manejo de errores especÃ­ficos de Prisma
    console.error('Error detallado:', error);
    if (error.code === 'P2002') { // Error de unicidad
      return res.status(409).json({ ok: false, data: null, error: 'Ya existe un registro con ese valor Ãºnico.' });
    }
    // 6. Error genÃ©rico
    res.status(500).json({ ok: false, data: null, error: 'OcurriÃ³ un error al procesar la solicitud.' });
  }
};

export const listarEntidades = async (req: Request, res: Response) => {
  try {
    // 1. Procesar parÃ¡metros de filtrado y paginaciÃ³n
    const page = Number(normalizeParam(req.query.page, 1));
    const limit = Number(normalizeParam(req.query.limit, 20));
    const q = normalizeParam(req.query.q, '');
    
    // 2. Validar y normalizar parÃ¡metros
    const pageNum = page > 0 ? page : 1;
    const limitNum = limit > 0 && limit <= 100 ? limit : 20;
    const skip = (pageNum - 1) * limitNum;
    
    // 3. Construir condiciones de bÃºsqueda
    const where: Record<string, any> = {};
    if (q.trim().length > 0) {
      where.OR = [
        { campo1: { contains: q.trim(), mode: 'insensitive' } },
        // Otros campos para bÃºsqueda
      ];
    }
    
    // 4. Ejecutar consulta con contador total
    const [entidades, total] = await Promise.all([
      prisma.entidad.findMany({ where, skip, take: limitNum, orderBy: { campo1: 'asc' } }),
      prisma.entidad.count({ where })
    ]);
    
    // 5. Respuesta con datos y metadatos de paginaciÃ³n
    res.status(200).json({
      ok: true,
      data: entidades,
      error: null,
      meta: {
        total,
        page: pageNum,
        limit: limitNum,
        pages: Math.ceil(total / limitNum)
      }
    });
  } catch (error) {
    console.error('Error al listar entidades:', error);
    res.status(500).json({ ok: false, data: null, error: 'OcurriÃ³ un error al listar las entidades.' });
  }
};
```

### 2. Validaciones recomendadas por tipo de dato

- **Strings**: Validar longitud mÃ­nima/mÃ¡xima y formato (ej. con regex para emails)
- **NÃºmeros**: Validar rango, tipo y valor positivo/negativo segÃºn caso
- **URLs**: Validar formato con regex `^https?:\/\/.+`
- **Fechas**: Validar formato y rango vÃ¡lido
- **IDs**: Validar formato UUID si aplica
- **Arrays**: Validar longitud y contenido

### 3. ConfiguraciÃ³n de rutas

Toda ruta debe seguir este patrÃ³n:

```typescript
router.post('/', authenticateJWT, requireRole('admin', 'otroRol'), controlador.crearEntidad);
router.get('/', authenticateJWT, controlador.listarEntidades);
router.get('/:id', authenticateJWT, controlador.obtenerEntidad);
router.put('/:id', authenticateJWT, requireRole('admin'), controlador.actualizarEntidad);
router.delete('/:id', authenticateJWT, requireRole('admin'), controlador.eliminarEntidad);
```

### 4. Helpers recomendados

**Para normalizar query params:**

```typescript
function normalizeParam<T = string>(param: any, fallback: T): T {
  if (Array.isArray(param)) {
    return param[0] ?? fallback;
  }
  return (param ?? fallback) as T;
}

function normalizeBooleanParam(param: any): boolean | undefined {
  if (Array.isArray(param)) param = param[0];
  if (param === true || param === 'true' || param === 1 || param === '1') return true;
  if (param === false || param === 'false' || param === 0 || param === '0') return false;
  return undefined;
}
```

## ConfiguraciÃ³n de autenticaciÃ³n

### JWT y middleware de autenticaciÃ³n

AsegÃºrate de implementar correctamente la autenticaciÃ³n JWT:

1. **ConfiguraciÃ³n de secreto**: Usa una variable de entorno segura
   ```
   JWT_SECRET=clave_segura_y_compleja_min_32_caracteres
   ```

2. **Emisor de tokens**: Al emitir tokens en login/registro, incluye:
   - ID de usuario
   - Roles del usuario
   - Tiempo de expiraciÃ³n (max 24h)

3. **Middleware de autenticaciÃ³n**: Siempre usa el middleware centralizado:
   ```typescript
   import { authenticateJWT } from '@/middlewares/auth';
   router.get('/ruta-protegida', authenticateJWT, miControlador);
   ```

### OAuth (Google, Facebook, Instagram)

**Importante**: Los callbacks de OAuth deben configurarse correctamente:

```
# URLs de callback (deben coincidir EXACTAMENTE con las configuradas en cada proveedor)
GOOGLE_CALLBACK_URL=http://localhost:4000/api/auth/google/callback
FACEBOOK_CALLBACK_URL=http://localhost:4000/api/auth/facebook/callback
INSTAGRAM_CALLBACK_URL=http://localhost:4000/api/auth/instagram/callback

# URL de redirecciÃ³n al frontend tras autenticaciÃ³n exitosa
FRONTEND_URL=http://localhost:3000
```

**Recordatorio**: 
- En desarrollo, los callbacks deben apuntar al backend, NO al frontend.
- En producciÃ³n, actualiza las URLs en los dashboards de cada proveedor OAuth.

### Control de roles y permisos

Utiliza el middleware de roles para proteger endpoints:

```typescript
import { requireRole } from '@/middlewares/roles';

// Ruta accesible solo para admin
router.delete('/:id', authenticateJWT, requireRole('admin'), controlador.eliminarEntidad);

// Ruta accesible para admin O vendedor O optometrista
router.post('/', authenticateJWT, requireRole('admin','vendedor','optometrista'), controlador.crearEntidad);
```

## Testing y buenas prÃ¡cticas

### Estructura de tests recomendada

Todos los tests deben seguir el patrÃ³n:

```typescript
describe('MÃ³dulo de Entidades', () => {
  let token: string;
  
  beforeAll(async () => {
    // Obtener token vÃ¡lido mediante login
    const res = await request(app).post('/api/auth/login').send({
      email: 'admin@neoptica.com',
      password: 'Admin1234!',
    });
    token = res.body.data.token;
  });
  
  describe('CreaciÃ³n de entidad', () => {
    it('debe crear una entidad vÃ¡lida', async () => { /* ... */ });
    it('debe rechazar datos invÃ¡lidos', async () => { /* ... */ });
  });
  
  describe('Listado de entidades', () => {
    it('debe listar entidades paginadas', async () => { /* ... */ });
    it('debe filtrar por nombre', async () => { /* ... */ });
  });
});
```

### Buenas prÃ¡cticas generales

- **TypeScript estricto**: Usa tipos explÃ­citos y corrige todos los errores del compilador.
- **Imports absolutos**: Usa rutas absolutas (`@/controllers/...`) en lugar de relativas.
- **No exponer datos sensibles**: Nunca incluyas passwords en respuestas API.
- **Logging**: Registra eventos crÃ­ticos (login, errores, acciones admin).
- **DocumentaciÃ³n**: Documenta con Swagger todos los endpoints nuevos.
- **ValidaciÃ³n estricta**: Valida todos los inputs, no confÃ­es en datos del cliente.
- **Formato de respuesta**: Siempre usa el formato `{ ok, data, error }` para todas las respuestas.
- **Manejo de errores**: Captura y maneja especÃ­ficamente los errores de Prisma.
- **Borrado lÃ³gico**: Implementa borrado lÃ³gico en lugar de fÃ­sico para entidades principales.
- **Middleware JWT**: Siempre protege rutas no pÃºblicas con `authenticateJWT`.


### AutenticaciÃ³n OAuth

**Problema**: Error `redirect_uri_mismatch` en OAuth de Google/Facebook/Instagram.

**SoluciÃ³n**: 
1. Asegurarse de que los callback URLs en `.env` coincidan EXACTAMENTE con los configurados en los dashboards de desarrollador de cada proveedor.
2. Recordar que los callbacks deben apuntar al backend (puerto 4000), no al frontend.
3. En desarrollo local usar `http://localhost:4000/api/auth/[proveedor]/callback`.

### Testing

**Problema**: Fallos en tests por falta de autenticaciÃ³n JWT vÃ¡lida.

**SoluciÃ³n**:
1. Siempre obtener un token vÃ¡lido mediante login real al inicio de cada suite de tests.
2. No confiar en tokens estÃ¡ticos o variables de entorno para tests.
3. Utilizar `beforeAll` para realizar el login y obtener el token.

### ValidaciÃ³n de datos

**Problema**: Errores 500 por datos invÃ¡lidos no validados.

**SoluciÃ³n**:
1. Implementar validaciÃ³n estricta de todos los campos en cada controlador.
2. Verificar tipos, rangos y formatos antes de operaciones de base de datos.
3. Devolver cÃ³digo 400 con mensaje claro cuando la validaciÃ³n falla.

## Contribuciones y flujo de trabajo
- Crea ramas tipo feature/nombre, fix/nombre o hotfix/nombre.
- Usa Conventional Commits (feat, fix, docs, chore, etc).
- Siempre documenta los cambios en el README.

## Licencia
Propiedad de NeÃ³ptica. Todos los derechos reservados.
